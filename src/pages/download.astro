---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import "../styles/global.css";
import SEO from "../components/SEO.astro";

type GHAsset = {
  name: string;
  browser_download_url: string;
  content_type?: string;
};
type GHRelease = {
  tag_name?: string;
  name?: string;
  body?: string;
  assets?: GHAsset[];
  html_url?: string;
  published_at?: string;
};

const org = "nook-browser";
const repo = "nook";

async function fetchJSON<T>(url: string): Promise<T> {
  const res = await fetch(url, {
    headers: { Accept: "application/vnd.github+json" },
  });
  if (!res.ok) throw new Error(`Failed ${url}: ${res.status}`);
  return (await res.json()) as T;
}

let release: GHRelease | null = null;
try {
  release = await fetchJSON<GHRelease>(
    `https://api.github.com/repos/${org}/${repo}/releases/latest`
  );
} catch (e) {
  release = null;
}

function pickMacAsset(assets: GHAsset[] | undefined) {
  const list = assets ?? [];
  return list.find((a) => /\.dmg$|\.pkg$|\.zip$/i.test(a.name));
}

const macAsset = pickMacAsset(release?.assets);
const versionLabel = release?.name ?? release?.tag_name ?? "Latest";
const publishedAt = release?.published_at
  ? new Date(release.published_at).toLocaleDateString()
  : undefined;
const releaseUrl =
  release?.html_url ?? `https://github.com/${org}/${repo}/releases`;
---

<html
  lang="en"
  class="h-full bg-fixed bg-[length:100%_100%] bg-[linear-gradient(135deg,_#F1EFDF,_#F9F8F4)]"
>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Download — Nook Browser</title>
    <SEO
      title="Download — Nook Browser"
      description="Get the latest macOS build of Nook."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Urbanist:wght@600;700;800&family=Inter:wght@400;500;600;700;800&family=Rethink+Sans:ital,wght@0,400..800;1,400..800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="min-h-screen w-full text-[#1b1b18] antialiased h-full">
    <Header />

    <section
      class="container mx-auto max-w-[1120px] px-[clamp(16px,5vw,28px)] text-center pt-[clamp(72px,18vw,120px)] pb-0 h-full"
      data-reveal-parent
    >
      <div class="flex flex-col items-center justify-center" data-reveal>
        <img src="/favicon.png" alt="Nook" class="w-16 h-16 sm:w-24 sm:h-24" />
      </div>
      <h1
        data-reveal
        data-reveal-delay="70"
        class="mt-8 font-medium tracking-tight leading-[1.1] text-4xl sm:text-5xl md:text-6xl [font-family:var(--font-rethink)] text-[#373230]"
      >
        Download Nook
      </h1>
      <p
        data-reveal
        data-reveal-delay="120"
        class="mt-3 mx-auto max-w-[720px] text-[#6b6b62] text-[clamp(14px,1.6vw,18px)] leading-normal"
      >
        Get the latest alpha release for your operating system. Open-source,
        private, and fast by design.
      </p>

      <div
        class="mt-[26px] flex justify-center gap-3"
        data-reveal
        data-reveal-delay="160"
      >
        <a
          href={macAsset?.browser_download_url ?? releaseUrl}
          class="inline-flex items-center justify-center gap-2 px-6 py-2.5 rounded-2xl bg-[#0f0f0e] text-white text-base font-medium border border-[#0f0f0e]"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            xml:space="preserve"
            width="14"
            height="14"
            viewBox="0 0 814 1000"
            fill="#fff"
            ><path
              d="M788.1 340.9c-5.8 4.5-108.2 62.2-108.2 190.5 0 148.4 130.3 200.9 134.2 202.2-.6 3.2-20.7 71.9-68.7 141.9-42.8 61.6-87.5 123.1-155.5 123.1s-85.5-39.5-164-39.5c-76.5 0-103.7 40.8-165.9 40.8s-105.6-57-155.5-127C46.7 790.7 0 663 0 541.8c0-194.4 126.4-297.5 250.8-297.5 66.1 0 121.2 43.4 162.7 43.4 39.5 0 101.1-46 176.3-46 28.5 0 130.9 2.6 198.3 99.2zm-234-181.5c31.1-36.9 53.1-88.1 53.1-139.3 0-7.1-.6-14.3-1.9-20.1-50.6 1.9-110.8 33.7-147.1 75.8-28.5 32.4-55.1 83.6-55.1 135.5 0 7.8 1.3 15.6 1.9 18.1 3.2.6 8.4 1.3 13.6 1.3 45.4 0 102.5-30.4 135.5-71.3z"
            ></path></svg
          >
          <span>Download Alpha</span>
        </a>
        <a
          class="inline-flex items-center justify-center gap-2 px-6 py-2.5 rounded-2xl border border-black/10 bg-white/70 backdrop-blur-md text-base font-medium"
          href="/whats-new"
          target="_blank"
          rel="noopener noreferrer"><span>What's New</span></a
        >
      </div>
      {
        release && (
          <p class="mt-4 text-xs text-[#6b6b62]">
            Latest alpha: {versionLabel}
          </p>
        )
      }
    </section>

    <Footer />
  </body>
</html>
