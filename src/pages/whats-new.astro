---
import Logo from "../components/Logo.svelte";
import Footer from "../components/Footer.astro";
import ChangelogList from "../components/ChangelogList.svelte";
import "../styles/global.css";
import Header from "../components/Header.astro";

const apiBase = "https://cms.browsewithnook.com";
type CMSImage = {
  url?: string;
  alt?: string;
  width?: number;
  height?: number;
};
type ChangelogEntry = {
  id: number | string;
  title: string;
  slug: string;
  version?: string;
  tag?: string;
  publishedAt?: string;
  createdAt?: string;
  summary?: string;
  image?: CMSImage;
};

export const prerender = false;

function formatDate(iso?: string): string {
  if (!iso) return "";
  return new Date(iso).toLocaleDateString();
}

const res = await fetch(`${apiBase}/api/changelog-entries/`, {
  cache: "no-store",
});
if (!res.ok) {
  throw new Error(`Failed to fetch changelog: ${res.status}`);
}
const data = (await res.json()) as { docs?: ChangelogEntry[] };
const entries: ChangelogEntry[] = Array.isArray(data?.docs) ? data.docs : [];

function groupByMonthYear(items: ChangelogEntry[]) {
  const map = new Map<string, ChangelogEntry[]>();
  for (const it of items) {
    const d = new Date(it.publishedAt ?? it.createdAt ?? Date.now());
    const key = d.toLocaleDateString(undefined, {
      year: "numeric",
      month: "long",
    });
    const arr = map.get(key) ?? [];
    arr.push(it);
    map.set(key, arr);
  }
  return Array.from(map.entries()).map(([label, items]) => ({ label, items }));
}

const groups = groupByMonthYear(entries);
---

<html
  lang="en"
  class="h-full bg-fixed bg-[length:100%_100%] bg-[linear-gradient(135deg,_#F1EFDF,_#F9F8F4)]"
>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>What's New â€” Nook</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Urbanist:wght@600;700;800&family=Inter:wght@400;500;600;700;800&family=Rethink+Sans:ital,wght@0,400..800;1,400..800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="min-h-screen w-full text-[#1b1b18] antialiased">
    <Header />

    <section
      class="container mx-auto max-w-[1120px] px-[clamp(16px,2vw,28px)] text-center pt-[clamp(36px,16vw,100px)] pb-0"
      data-reveal-parent
    >
      <h1
        data-reveal
        class="font-medium tracking-tight leading-[1.1] text-3xl sm:text-5xl md:text-6xl [font-family:var(--font-rethink)] text-[#373230]"
      >
        What's New
      </h1>
      <p class="mt-3 text-[#6b6b62] text-sm" data-reveal data-reveal-delay="90">
        Changelog and release notes from the Nook team.
      </p>
    </section>

    <section
      class="container mx-auto max-w-[1120px] px-[clamp(16px,2vw,28px)] py-[clamp(24px,8vw,56px)]"
      data-reveal
      data-reveal-delay="140"
    >
      <ChangelogList client:load groups={groups} />
    </section>

    <Footer />
  </body>
</html>
